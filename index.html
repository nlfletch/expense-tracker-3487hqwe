<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceSpend - Expense Tracker</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.47059;
            font-weight: 400;
        }
        
        .app {
            max-width: 428px;
            margin: 0 auto;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .header {
            background: white;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e5e7;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 12px;
        }
        
        .header-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .btn-header {
            background: #007AFF;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .user-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #6e6e73;
        }
        
        .view-mode-select {
            background: #f2f2f7;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
        }
        
        .user-selector {
            display: flex;
            background: #f2f2f7;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .user-btn {
            flex: 1;
            padding: 8px 16px;
            background: transparent;
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .user-btn.active {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .categories-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding: 20px;
        }
        
        .category-card {
            background: #f6f6f6;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .category-card:hover {
            transform: scale(1.02);
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .category-name {
            font-size: 16px;
            font-weight: 600;
        }
        
        .category-amounts {
            text-align: right;
        }
        
        .spent-amount {
            font-size: 18px;
            font-weight: 700;
        }
        
        .remaining-amount {
            font-size: 12px;
            font-weight: 600;
            margin-top: 2px;
        }
        
        .remaining-amount.over {
            color: #ff3b30;
        }
        
        .remaining-amount.warning {
            color: #ff9500;
        }
        
        .remaining-amount.good {
            color: #34c759;
        }
        
        .category-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #6e6e73;
            margin-bottom: 8px;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e5e5e7;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .progress-fill.good {
            background: #34c759;
        }
        
        .progress-fill.warning {
            background: #ff9500;
        }
        
        .progress-fill.over {
            background: #ff3b30;
        }
        
        .voice-section {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            border-radius: 20px 20px 0 0;
            max-width: 428px;
            width: 100%;
        }
        
        .input-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 12px;
        }
        
        .voice-button, .manual-button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: transform 0.1s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .voice-button.listening {
            background: #ff3b30;
            transform: scale(1.1);
        }
        
        .voice-button:not(.listening) {
            background: #007AFF;
        }
        
        .manual-button {
            background: #34c759;
        }
        
        .manual-button:hover {
            transform: scale(1.05);
        }
        
        .voice-button svg, .manual-button svg {
            width: 28px;
            height: 28px;
            fill: white;
        }
        
        .voice-status {
            text-align: center;
            font-size: 12px;
            color: #6e6e73;
        }
        
        .manual-entry-form {
            background: #f6f6f6;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        
        .manual-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 12px;
        }
        
        .manual-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-manual {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .btn-manual.primary {
            background: #007AFF;
            color: white;
        }
        
        .btn-manual.secondary {
            background: #f2f2f7;
            color: #007AFF;
        }
        
        .btn-manual:disabled {
            background: #d1d1d6;
            color: #6e6e73;
            cursor: not-allowed;
        }
        
        .recognized-text {
            background: #f6f6f6;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 20px;
            border-radius: 12px;
            max-height: 80vh;
            overflow-y: auto;
            width: 100%;
            max-width: 400px;
        }
        
        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e5e7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .btn-close {
            background: none;
            border: none;
            font-size: 16px;
            color: #007AFF;
            cursor: pointer;
        }
        
        .expense-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .expense-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f2f2f7;
        }
        
        .expense-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .expense-amount {
            font-size: 16px;
            font-weight: 600;
        }
        
        .expense-user {
            font-size: 12px;
            color: #6e6e73;
        }
        
        .expense-date {
            font-size: 12px;
            color: #6e6e73;
            margin-bottom: 4px;
        }
        
        .expense-transcription {
            font-size: 12px;
            color: #007AFF;
            font-style: italic;
        }
        
        .form-section {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .form-buttons {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid #e5e5e7;
        }
        
        .btn-primary {
            flex: 1;
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .btn-secondary {
            flex: 1;
            background: #f2f2f7;
            color: #007AFF;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .btn-primary:disabled {
            background: #d1d1d6;
            color: #6e6e73;
            cursor: not-allowed;
        }
        
        .list-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f2f2f7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .list-item-content {
            flex: 1;
        }
        
        .list-item-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .list-item-subtitle {
            font-size: 12px;
            color: #6e6e73;
        }
        
        .btn-edit {
            background: #007AFF;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .combined-badge {
            font-size: 10px;
            color: #007AFF;
            margin-top: 2px;
        }
        
        .no-expenses {
            text-align: center;
            padding: 40px 20px;
            color: #6e6e73;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Initial data
        const initialCategories = [
            { id: '1', name: 'Coffee', monthlyBudget: 100, color: 'brown' },
            { id: '2', name: 'Groceries', monthlyBudget: 600, color: 'green' },
            { id: '3', name: 'Dining Out', monthlyBudget: 200, color: 'orange' },
            { id: '4', name: 'Gas', monthlyBudget: 150, color: 'blue' }
        ];

        const initialUsers = [
            { id: '1', name: 'Me' },
            { id: '2', name: 'Wife' }
        ];

        // Utility functions
        const generateId = () => Math.random().toString(36).substring(2) + Date.now().toString(36);

        const formatDate = (date) => {
            return new Intl.DateTimeFormat('en-US', {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            }).format(date);
        };

        const parseExpense = (text, categories) => {
            const lowercaseText = text.toLowerCase();
            
            // Find category
            let foundCategory = null;
            for (const category of categories) {
                if (lowercaseText.includes(category.name.toLowerCase())) {
                    foundCategory = category.name;
                    break;
                }
            }
            
            // Extract amount
            const pattern = /\$?(\d+\.?\d*)/;
            const match = text.match(pattern);
            
            if (match) {
                const amount = parseFloat(match[1]);
                return { category: foundCategory || 'Other', amount };
            }
            
            return null;
        };

        const getCurrentMonthExpenses = (expenses, category, user = null) => {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            return expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                const matchesMonth = expenseDate.getMonth() === currentMonth && 
                                   expenseDate.getFullYear() === currentYear;
                const matchesCategory = expense.category.toLowerCase() === category.toLowerCase();
                const matchesUser = user === null || expense.user === user;
                
                return matchesMonth && matchesCategory && matchesUser;
            });
        };

        const getMonthlyExpenses = (expenses, month, year, category = null, user = null) => {
            return expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                const matchesMonth = expenseDate.getMonth() === month && 
                                   expenseDate.getFullYear() === year;
                const matchesCategory = category === null || expense.category.toLowerCase() === category.toLowerCase();
                const matchesUser = user === null || expense.user === user;
                
                return matchesMonth && matchesCategory && matchesUser;
            });
        };

        const getAvailableMonths = (expenses) => {
            const months = new Set();
            expenses.forEach(expense => {
                const date = new Date(expense.date);
                const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                months.add(monthKey);
            });
            
            return Array.from(months)
                .map(monthKey => {
                    const [year, month] = monthKey.split('-').map(Number);
                    return { year, month };
                })
                .sort((a, b) => {
                    if (a.year !== b.year) return b.year - a.year;
                    return b.month - a.month;
                });
        };

        const formatMonthYear = (month, year) => {
            const date = new Date(year, month);
            return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        };

        const CategoryCard = ({ category, expenses, viewMode, currentUser, onClick }) => {
            const userFilter = viewMode === 'individual' ? currentUser : null;
            const categoryExpenses = getCurrentMonthExpenses(expenses, category.name, userFilter);
            const spent = categoryExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const remaining = Math.max(category.monthlyBudget - spent, 0);
            const progress = Math.min(spent / category.monthlyBudget, 1);
            const isOverBudget = spent > category.monthlyBudget;
            
            const getProgressClass = () => {
                if (isOverBudget) return 'over';
                if (progress > 0.8) return 'warning';
                return 'good';
            };
            
            const getRemainingClass = () => {
                if (isOverBudget) return 'over';
                if (progress > 0.8) return 'warning';
                return 'good';
            };
            
            return (
                <div className="category-card" onClick={onClick}>
                    <div className="category-header">
                        <div>
                            <div className="category-name">{category.name}</div>
                            {viewMode === 'combined' && (
                                <div className="combined-badge">Combined</div>
                            )}
                        </div>
                        <div className="category-amounts">
                            <div className="spent-amount">${Math.ceil(spent)}</div>
                            <div className={`remaining-amount ${getRemainingClass()}`}>
                                {isOverBudget 
                                    ? `${Math.ceil(spent - category.monthlyBudget)} over`
                                    : `${Math.ceil(remaining)} left`
                                }
                            </div>
                        </div>
                    </div>
                    <div className="category-footer">
                        <span>Budget: ${Math.ceil(category.monthlyBudget)}</span>
                        <span>{Math.round(progress * 100)}%</span>
                    </div>
                    <div className="progress-bar">
                        <div 
                            className={`progress-fill ${getProgressClass()}`}
                            style={{ width: `${Math.min(progress * 100, 100)}%` }}
                        />
                    </div>
                </div>
            );
        };

        const VoiceInput = ({ onExpenseAdded, categories, currentUser }) => {
            const [isListening, setIsListening] = useState(false);
            const [recognizedText, setRecognizedText] = useState('');
            const [recognition, setRecognition] = useState(null);
            const [showManualEntry, setShowManualEntry] = useState(true); // Default to manual entry
            const [manualText, setManualText] = useState('');

            useEffect(() => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    
                    recognition.continuous = false;
                    recognition.interimResults = false; // Simplified - only final results
                    recognition.lang = 'en-US';
                    
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        setRecognizedText(transcript);
                        // Immediately process when we get a result
                        processExpenseInput(transcript);
                    };
                    
                    recognition.onend = () => {
                        setIsListening(false);
                        setRecognizedText('');
                    };
                    
                    recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        setIsListening(false);
                        alert('Speech recognition failed. Please use text input instead.');
                    };
                    
                    setRecognition(recognition);
                }
            }, []);

            const processExpenseInput = (text) => {
                if (!text) return false;
                
                console.log('Processing text:', text);
                
                const parsed = parseExpense(text, categories);
                console.log('Parsed result:', parsed);
                
                if (parsed && parsed.amount > 0) {
                    const expense = {
                        id: generateId(),
                        amount: parsed.amount,
                        category: parsed.category,
                        date: new Date().toISOString(),
                        user: currentUser,
                        rawTranscription: text
                    };
                    console.log('Adding expense:', expense);
                    onExpenseAdded(expense);
                    
                    // Show success feedback
                    alert(`Added ${parsed.amount} to ${parsed.category}`);
                    return true;
                } else {
                    alert(`Could not parse "${text}". Try format: "coffee 6.24" or "coffee $6"`);
                }
                return false;
            };

            const handleManualSubmit = () => {
                if (processExpenseInput(manualText)) {
                    setManualText('');
                }
            };

            const toggleListening = () => {
                if (!recognition) {
                    alert('Speech recognition not supported. Please use text input.');
                    return;
                }

                if (isListening) {
                    recognition.stop();
                } else {
                    setRecognizedText('');
                    setShowManualEntry(false);
                    recognition.start();
                    setIsListening(true);
                }
            };

            const toggleManualEntry = () => {
                if (isListening) {
                    recognition.stop();
                }
                setShowManualEntry(!showManualEntry);
                setRecognizedText('');
            };

            return (
                <div className="voice-section">
                    {recognizedText && (
                        <div className="recognized-text">
                            {recognizedText}
                        </div>
                    )}
                    
                    {showManualEntry && (
                        <div className="manual-entry-form">
                            <input
                                type="text"
                                className="manual-input"
                                value={manualText}
                                onChange={(e) => setManualText(e.target.value)}
                                placeholder='Type: "coffee 6.24" or "groceries 45"'
                                onKeyPress={(e) => e.key === 'Enter' && handleManualSubmit()}
                                autoFocus
                            />
                            <div className="manual-buttons">
                                <button 
                                    className="btn-manual secondary"
                                    onClick={() => setShowManualEntry(false)}
                                >
                                    Cancel
                                </button>
                                <button 
                                    className="btn-manual primary"
                                    onClick={handleManualSubmit}
                                    disabled={!manualText.trim()}
                                >
                                    Add Expense
                                </button>
                            </div>
                        </div>
                    )}
                    
                    <div className="input-buttons">
                        <button 
                            className={`voice-button ${isListening ? 'listening' : ''}`}
                            onClick={toggleListening}
                        >
                            {isListening ? (
                                <svg viewBox="0 0 24 24">
                                    <rect x="6" y="6" width="12" height="12" rx="2"/>
                                </svg>
                            ) : (
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 2C13.1 2 14 2.9 14 4V10C14 11.1 13.1 12 12 12C10.9 12 10 11.1 10 10V4C10 2.9 10.9 2 12 2M19 10C19 14.4 15.4 18 11 18V20H6V22H18V20H13V18C17.4 18 21 14.4 21 10H19Z"/>
                                </svg>
                            )}
                        </button>
                        
                        <button 
                            className="manual-button"
                            onClick={toggleManualEntry}
                        >
                            <svg viewBox="0 0 24 24">
                                <path d="M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04Z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div className="voice-status">
                        {isListening ? 'Listening...' : showManualEntry ? 'Type expense above' : 'Voice or Type'}
                    </div>
                </div>
            );
        };

        const CategoryDetail = ({ category, expenses, currentUser, viewMode, onClose, onExpenseUpdate, onExpenseDelete }) => {
            const userFilter = viewMode === 'individual' ? currentUser : null;
            const categoryExpenses = getCurrentMonthExpenses(expenses, category.name, userFilter)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            const total = categoryExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const [editingExpense, setEditingExpense] = useState(null);

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <div>
                                <div className="modal-title">{category.name}</div>
                                <div style={{ fontSize: '12px', color: '#6e6e73', marginTop: '4px' }}>
                                    {viewMode === 'combined' ? 'Combined View' : currentUser}
                                </div>
                            </div>
                            <button className="btn-close" onClick={onClose}>Done</button>
                        </div>
                        
                        <div style={{ padding: '16px 20px', borderBottom: '1px solid #f2f2f7' }}>
                            <div style={{ fontSize: '18px', fontWeight: '600', marginBottom: '4px' }}>
                                Total this month: ${total.toFixed(2)}
                            </div>
                            <div style={{ fontSize: '14px', color: '#6e6e73' }}>
                                Budget: ${category.monthlyBudget.toFixed(2)}
                            </div>
                        </div>
                        
                        <div className="expense-list">
                            {categoryExpenses.length === 0 ? (
                                <div className="no-expenses">No expenses this month</div>
                            ) : (
                                categoryExpenses.map(expense => (
                                    <ExpenseRow 
                                        key={expense.id} 
                                        expense={expense}
                                        onEdit={() => setEditingExpense(expense)}
                                        onDelete={() => {
                                            if (confirm(`Delete ${expense.amount.toFixed(2)} expense?`)) {
                                                onExpenseDelete(expense);
                                            }
                                        }}
                                    />
                                ))
                            )}
                        </div>
                        
                        {editingExpense && (
                            <EditExpenseModal
                                expense={editingExpense}
                                onSave={(updatedExpense) => {
                                    onExpenseUpdate(updatedExpense);
                                    setEditingExpense(null);
                                }}
                                onCancel={() => setEditingExpense(null)}
                            />
                        )}
                    </div>
                </div>
            );
        };

        const CategorySettings = ({ categories, onUpdate, onClose }) => {
            const [editingCategory, setEditingCategory] = useState(null);
            const [showAddForm, setShowAddForm] = useState(false);

            const handleEdit = (category) => {
                setEditingCategory(category);
            };

            const handleSave = (categoryData) => {
                onUpdate(categoryData);
                setEditingCategory(null);
                setShowAddForm(false);
            };

            const handleAdd = () => {
                setShowAddForm(true);
            };

            if (editingCategory || showAddForm) {
                return (
                    <CategoryForm
                        category={editingCategory}
                        onSave={handleSave}
                        onCancel={() => {
                            setEditingCategory(null);
                            setShowAddForm(false);
                        }}
                    />
                );
            }

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <span className="modal-title">Categories</span>
                            <button className="btn-close" onClick={onClose}>Done</button>
                        </div>
                        <div>
                            {categories.map(category => (
                                <div key={category.id} className="list-item">
                                    <div className="list-item-content">
                                        <div className="list-item-title">{category.name}</div>
                                        <div className="list-item-subtitle">
                                            Budget: ${category.monthlyBudget.toFixed(0)}
                                        </div>
                                    </div>
                                    <button 
                                        className="btn-edit"
                                        onClick={() => handleEdit(category)}
                                    >
                                        Edit
                                    </button>
                                </div>
                            ))}
                        </div>
                        <div className="form-buttons">
                            <button className="btn-primary" onClick={handleAdd}>
                                Add Category
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const CategoryForm = ({ category, onSave, onCancel }) => {
            const [name, setName] = useState(category?.name || '');
            const [budget, setBudget] = useState(category?.monthlyBudget?.toString() || '');
            const [color, setColor] = useState(category?.color || 'blue');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name || !budget) return;

                onSave({
                    id: category?.id || generateId(),
                    name,
                    monthlyBudget: parseFloat(budget),
                    color
                });
            };

            return (
                <div className="modal" onClick={onCancel}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <span className="modal-title">
                                {category ? 'Edit Category' : 'Add Category'}
                            </span>
                            <button className="btn-close" onClick={onCancel}>Cancel</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-section">
                                <div className="form-group">
                                    <label className="form-label">Name</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={name}
                                        onChange={(e) => setName(e.target.value)}
                                        placeholder="Category name"
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">Monthly Budget</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        className="form-input"
                                        value={budget}
                                        onChange={(e) => setBudget(e.target.value)}
                                        placeholder="0.00"
                                    />
                                </div>
                            </div>
                            
                            <div className="form-buttons">
                                <button type="button" className="btn-secondary" onClick={onCancel}>
                                    Cancel
                                </button>
                                <button 
                                    type="submit" 
                                    className="btn-primary"
                                    disabled={!name || !budget}
                                >
                                    Save
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const UserSettings = ({ users, currentUser, onUpdate, onClose, onSetCurrentUser }) => {
            const [editingUser, setEditingUser] = useState(null);
            const [showAddForm, setShowAddForm] = useState(false);

            const handleEdit = (user) => {
                setEditingUser(user);
            };

            const handleSave = (userData) => {
                onUpdate(userData);
                setEditingUser(null);
                setShowAddForm(false);
            };

            const handleAdd = () => {
                setShowAddForm(true);
            };

            if (editingUser || showAddForm) {
                return (
                    <UserForm
                        user={editingUser}
                        onSave={handleSave}
                        onCancel={() => {
                            setEditingUser(null);
                            setShowAddForm(false);
                        }}
                        onSetCurrent={onSetCurrentUser}
                        currentUser={currentUser}
                    />
                );
            }

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <span className="modal-title">Users</span>
                            <button className="btn-close" onClick={onClose}>Done</button>
                        </div>
                        <div>
                            {users.map(user => (
                                <div key={user.id} className="list-item">
                                    <div className="list-item-content">
                                        <div className="list-item-title">
                                            {user.name}
                                            {user.name === currentUser && (
                                                <span style={{ color: '#007AFF', fontSize: '12px', marginLeft: '8px' }}>
                                                    (Current)
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                    <button 
                                        className="btn-edit"
                                        onClick={() => handleEdit(user)}
                                    >
                                        Edit
                                    </button>
                                </div>
                            ))}
                        </div>
                        <div className="form-buttons">
                            <button className="btn-primary" onClick={handleAdd}>
                                Add User
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const UserForm = ({ user, onSave, onCancel, onSetCurrent, currentUser }) => {
            const [name, setName] = useState(user?.name || '');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name) return;

                onSave({
                    id: user?.id || generateId(),
                    name
                });
            };

            const handleSetCurrent = () => {
                if (user) {
                    onSetCurrent(user.name);
                    onCancel();
                }
            };

            return (
                <div className="modal" onClick={onCancel}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <span className="modal-title">
                                {user ? 'Edit User' : 'Add User'}
                            </span>
                            <button className="btn-close" onClick={onCancel}>Cancel</button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-section">
                                <div className="form-group">
                                    <label className="form-label">Name</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={name}
                                        onChange={(e) => setName(e.target.value)}
                                        placeholder="User name"
                                    />
                                </div>
                                
                                {user && (
                                    <div className="form-group">
                                        <button 
                                            type="button" 
                                            className="btn-secondary"
                                            onClick={handleSetCurrent}
                                            disabled={currentUser === user.name}
                                            style={{ width: '100%' }}
                                        >
                                            {currentUser === user.name ? 'Current User' : 'Set as Current User'}
                                        </button>
                                    </div>
                                )}
                            </div>
                            
                            <div className="form-buttons">
                                <button type="button" className="btn-secondary" onClick={onCancel}>
                                    Cancel
                                </button>
                                <button 
                                    type="submit" 
                                    className="btn-primary"
                                    disabled={!name}
                                >
                                    Save
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [expenses, setExpenses] = useState([]);
            const [categories, setCategories] = useState(initialCategories);
            const [users, setUsers] = useState(initialUsers);
            const [currentUser, setCurrentUser] = useState('Me');
            const [viewMode, setViewMode] = useState('combined');
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [showCategorySettings, setShowCategorySettings] = useState(false);
            const [showUserSettings, setShowUserSettings] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [selectedHistoryMonth, setSelectedHistoryMonth] = useState(null);

            // Load data from localStorage on mount
            useEffect(() => {
                const savedExpenses = localStorage.getItem('voicespend-expenses');
                const savedCategories = localStorage.getItem('voicespend-categories');
                const savedUsers = localStorage.getItem('voicespend-users');
                const savedCurrentUser = localStorage.getItem('voicespend-current-user');
                const savedViewMode = localStorage.getItem('voicespend-view-mode');

                if (savedExpenses) setExpenses(JSON.parse(savedExpenses));
                if (savedCategories) setCategories(JSON.parse(savedCategories));
                if (savedUsers) setUsers(JSON.parse(savedUsers));
                if (savedCurrentUser) setCurrentUser(savedCurrentUser);
                if (savedViewMode) setViewMode(savedViewMode);
            }, []);

            // Save to localStorage whenever data changes
            useEffect(() => {
                localStorage.setItem('voicespend-expenses', JSON.stringify(expenses));
            }, [expenses]);

            useEffect(() => {
                localStorage.setItem('voicespend-categories', JSON.stringify(categories));
            }, [categories]);

            useEffect(() => {
                localStorage.setItem('voicespend-users', JSON.stringify(users));
            }, [users]);

            useEffect(() => {
                localStorage.setItem('voicespend-current-user', currentUser);
            }, [currentUser]);

            useEffect(() => {
                localStorage.setItem('voicespend-view-mode', viewMode);
            }, [viewMode]);

            const handleExpenseAdded = (expense) => {
                setExpenses(prev => [...prev, expense]);
            };

            const handleExpenseUpdate = (updatedExpense) => {
                setExpenses(prev => 
                    prev.map(expense => 
                        expense.id === updatedExpense.id ? updatedExpense : expense
                    )
                );
            };

            const handleExpenseDelete = (expenseToDelete) => {
                setExpenses(prev => 
                    prev.filter(expense => expense.id !== expenseToDelete.id)
                );
            };

            const handleCategoryUpdate = (categoryData) => {
                if (categories.find(c => c.id === categoryData.id)) {
                    // Update existing
                    setCategories(prev => 
                        prev.map(c => c.id === categoryData.id ? categoryData : c)
                    );
                } else {
                    // Add new
                    setCategories(prev => [...prev, categoryData]);
                }
            };

            const handleUserUpdate = (userData) => {
                if (users.find(u => u.id === userData.id)) {
                    // Update existing
                    setUsers(prev => 
                        prev.map(u => u.id === userData.id ? userData : u)
                    );
                } else {
                    // Add new
                    setUsers(prev => [...prev, userData]);
                }
            };

            const handleUserSelect = (userName) => {
                setCurrentUser(userName);
            };

            const handleViewModeChange = (mode) => {
                setViewMode(mode);
            };

            return (
                <div className="app">
                    <div className="header">
                        <div className="header-buttons">
                            <button 
                                className="btn-header"
                                onClick={() => setShowUserSettings(true)}
                            >
                                Users
                            </button>
                            <button 
                                className="btn-header"
                                onClick={() => setShowHistory(true)}
                            >
                                History
                            </button>
                            <button 
                                className="btn-header"
                                onClick={() => setShowCategorySettings(true)}
                            >
                                Categories
                            </button>
                        </div>
                        
                        <h1>Expense Tracker</h1>
                        
                        <div className="user-controls">
                            <div className="user-info">
                                <span>Current User:</span>
                                <select 
                                    className="view-mode-select"
                                    value={viewMode}
                                    onChange={(e) => handleViewModeChange(e.target.value)}
                                >
                                    <option value="individual">My Expenses</option>
                                    <option value="combined">Combined</option>
                                </select>
                            </div>
                            
                            <div className="user-selector">
                                {users.map(user => (
                                    <button
                                        key={user.id}
                                        className={`user-btn ${currentUser === user.name ? 'active' : ''}`}
                                        onClick={() => handleUserSelect(user.name)}
                                    >
                                        {user.name}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="categories-grid">
                        {categories.map(category => (
                            <CategoryCard
                                key={category.id}
                                category={category}
                                expenses={expenses}
                                viewMode={viewMode}
                                currentUser={currentUser}
                                onClick={() => setSelectedCategory(category)}
                            />
                        ))}
                    </div>

                    <VoiceInput
                        onExpenseAdded={handleExpenseAdded}
                        categories={categories}
                        currentUser={currentUser}
                    />

                    {selectedCategory && (
                        <CategoryDetail
                            category={selectedCategory}
                            expenses={expenses}
                            currentUser={currentUser}
                            viewMode={viewMode}
                            onClose={() => setSelectedCategory(null)}
                            onExpenseUpdate={handleExpenseUpdate}
                            onExpenseDelete={handleExpenseDelete}
                        />
                    )}

                    {showCategorySettings && (
                        <CategorySettings
                            categories={categories}
                            onUpdate={handleCategoryUpdate}
                            onClose={() => setShowCategorySettings(false)}
                        />
                    )}

                    {showUserSettings && (
                        <UserSettings
                            users={users}
                            currentUser={currentUser}
                            onUpdate={handleUserUpdate}
                            onClose={() => setShowUserSettings(false)}
                            onSetCurrentUser={setCurrentUser}
                        />
                    )}

                    {showHistory && (
                        <HistoryView
                            expenses={expenses}
                            categories={categories}
                            currentUser={currentUser}
                            viewMode={viewMode}
                            onClose={() => {
                                setShowHistory(false);
                                setSelectedHistoryMonth(null);
                            }}
                            selectedMonth={selectedHistoryMonth}
                            onSelectMonth={setSelectedHistoryMonth}
                        />
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>